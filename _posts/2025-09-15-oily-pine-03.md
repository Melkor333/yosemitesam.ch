---
title: Oily Pine - Chapter 3 (Bubblewrap)
post:
  excerpt: "Improve the package builds by using bubblewrap and official tooling."
---

This is the second article in a mini series of 3 Blog posts:
- [How can we even build packages?]({{ site.baseurl}}/oily-pine-01)
- What do we do with 1000 failed packages?
- [Improving the process and making it official]({{ site.baseurl}}/oily-pine-03)

In the [last article]({{ site.baseurl}}/oily-pine-01) I've shown how I successfully built 82% of about 6500 packages.

## Alpine Linux + Rootbld

I thought about this for a while and found out that `abuild` has an option called `rootbld`, which builds a single package inside a [bubblewrap sandbox](https://github.com/containers/bubblewrap) (which is more or less a chroot). And `buildrepo` (the tool I use in `package.sh` to build all packages) has a flag to execute each build in a separate sandbox (using `abuild rootbld` under the hood).

Given that Iâ€™ve also seen a few packages fail because they couldnâ€™t spawn a (nested) container for tests, I thought that maybe using the official tooling could solve that issue as well. At the same time, Andy and me discussed the project and how long it took to build the packages initially. He had the idea to use the Github Sponsors money we got over the years for some rented hardware to speed up the process. I investigated a bit and found that a [Hetzner EX44](https://www.hetzner.com/dedicated-rootserver/ex44/configurator/#/) has a super price/performance ratio and matches the budget/requirements very well ([comparison to the processor of the initial build](https://www.cpubenchmark.net/compare/4993vs1191/Intel-i5-13500-vs-Intel-Xeon-E3-1245-V2)).


To potentially fix both the nested container and the phdr/c compiler issues - and to lean a bit more into Alpine upstream tooling - I decided to create a big Alpine Linux VM when I got access to the physical Server. And so I began getting ready to build packages with Oils in a bubblewrap chroot directly on Alpine.

Configuring the VM itself didnâ€™t require much more than running the `setup-build-env.sh` script, moving the repo to `/home/packager/aports` and this time creating softlinks for the directories I used to mount into the container.

### Adjusting Abuild

Abuild sets up a chroot directory by installing a hardcoded list of packages into a temporary directory.
This list needed to be adjusted to install the Oils packages as well:


```shell
# abuild command to prepare the build environment

echo "installing oils!"
$SUDO_APK add --initdb --update \
      --no-interactive \
      --arch $CBUILD_ARCH \
      --root "$BUILD_ROOT" \
      ${cachedir:+--cache-dir $cachedir} \
      abuild alpine-base build-base git $hostdeps $builddeps oils-for-unix-binsh \
      ${USE_CCACHE:+ccache}
```

All I had to do was add `oils-for-unix-binsh`. Thatâ€™s it!

Notice that this time I didnâ€™t install `oils-for-unix` or `oils-for-unix-bash`. `oils-for-unix-binsh` depends on `oils-for-unix`, so I donâ€™t need to explicitly specify that anyway. And I decided to not replace `/bin/bash` *yet*...

### Stonks?!

...because Andy "secured" another NLNet Grant!

| The [NLNet Foundation](https://nlnet.nl/) has various programs to fund projects that contribute to an open internet for all.<br />The Oils project has already been able to vastly improve different parts with 3 prior funds. For example the garbage collector built into Oils was mostly funded with the second grant. And the last grant was used to make the docs much more usable, as well as adding a lot more spec tests (and builtins) for ysh. |

In the second quarter of this year, Andy filled in the form for the fourth grant with the objective of stabilizing the Shell/Bash compatible part of the project. And believing in my work, he wanted to base it off of this project! ðŸ¤©

The idea is to use the grant to find and fix bugs - with the help of oily-pine!
The "event loop" is basically:
- analyze why package X doesnâ€™t build
- reduce the bug to a simple spec test
- fix it

BTW. Iâ€™m terrible at actually fixing bugs in the Oils codebase. Iâ€™m a Systems Engineer, not a Developer! But luckily, there are people like Andy who can do the coding. It's already useful when I only analyze the bugs. :)

To keep the scope reasonable, we decided to only focus on the `main` repo in the beginning - and only replace `/bin/sh`. We do think POSIX is a good and realistic target. It's easy to extend the the scope to more packages and Bash later on.

| We also do hope to attract more contributors with the grant. If **you** are interested, please hit us up on [zulip](https://oilshell.zulipchat.com/)! :) |

## Categorical

I digressed... With `oils-for-unix-binsh` added to the package list, `abuild rootbld` just works as expected. The only thing left was to run the command `buildrepo -k -l "$HOME/logs" main`.

This time I successfully built 1365/1580 packages (215 failures) in not even a day! The new server was really worth it. The 86% success rate is actually still not much, but with the grant in place I actually never even calculated the number until writing this article.

Now that the failed package count wasn't over 1000 anymore and I wanted to name some known bugs correctly, I went for manually categorizing the failed packages. I wrote yet another [small script](https://github.com/Melkor333/oily-pine/blob/9cb57f0efc7a96d4c98e337f6d7f9802c57ca419/oily/logs.ysh#L49) which showed me the error log, gave me an [FZF prompt](https://junegunn.github.io/fzf/) to select an existing category and when I pressed `ctrl+c` it asked for a new category description. In only around 2 hours of manual work the second categorization was done!

| Fun fact: I did most of the categorizations on the phone using [JuiceSSH](https://juicessh.com/) when I was in the train, on the toilet or walking my baby to sleep in the baby carrier. Not only that, but most of the work for this whole project was actually done on my phone! I have several projects that only exist inside of a [Termux](https://termux.dev/en/) terminal. |

I created a repository to keep the logs, you can find them [on github](https://github.com/Melkor333/oily-pine-logs).
And this is how the summary looks like:

```
     59 ifs=\\
     39 broken testsuite
     25 cmake error - compatibility unsupported
     15 libtool invalid word while parsing
     11 mkdir: unrecognized option: /
     10 config.status compile error
     10 abuild dependency issue (e.g. depends on busybox-binsh)
      9 abuild - fetch source issue
      6 (( .. ) .. )
      5 atf-test-program fail
      4 gpgrt-config timeout
      3 OSH command not found
      2 missing header file
      1 unexpected rustc version (alpine issue?)
      1 print oils ast error
      1 osh printf doesn't support single characters
      1 ninja build failure
      1 missing FNM_EXTMATCH support in libc
      1 meson test - test must be compiled first
      1 meson test - file not found
      1 libtool unrecognized macro
      1 ifs=\
      1 couldn't fetch source during build
      1 configure: error: can't find a separator character in '+,;&' for the path_replacer shell script
      1 configure.ac terminate called after throwing an instance of 'IndexError*'
      1 config.status (test) Unexpected trailing word '--'
      1 compile time error
      1 abuild - cant fetch package index
      1 Makefile Error 1
      1 'trap' requires a signal or hook name
215 /home/packager/oily-pine/oily/logs/issues
```

Now we have a list of 30 rough categories of bugs with a useful priorisation to look at! ðŸ¥³ðŸŽ‰ðŸ¥³ðŸŽ‰ðŸ¥³ðŸŽ‰

## Epilogue

We only built a fraction of all the packages, and there are still a lot of build failures.
But it's enough to prove the idea works. The next step is now to turn these failing packages into test cases and fix them.
You'll definitely get more updates on the [Oils Blog](https://oils.pub/blog/). Because besides fixing bugs, writing or talking about the work done is also an important part of the NLNet grant. We're planning to publish "Bug Post Mortems", writing about the journey from failed package to fixed bug.

### Plot-Twist

One last thing happened: Andy mostly rebuilt the packaging logic a *third time* directly in the Oils repository, for 2 Reasons:
- He didn't want to depend on an Alpine VM, thus using `abuild rootbld` directly doesn't work. But his tool only uses an Alpine *chroot*.
- He wanted to trigger the builds in a pipeline and generate HTML tables
   - His script fetches all the source tarballs in a perparation step. Thus downloading these files isn't required anymore (oily-pine fetches them every time)
   - One thing I haven't even mentioned is a "baseline build" using `busybox ash`. Because it turns out some packages don't even build with a stock build environment. The logs of these packages are irrelevant to us for the moment. And apparently there are *over a hundred* build failures in the baseline build, which is crazy. There is now an additional task in our todolist to reduce these baseline build failures!
   - There needed to be various extra scripts to generate useful HTML output from the CI.

I was very glad that he spent the 2 weeks of effort, because now we have a very nice and short dashboard with only the packages we should really focus on. 

With some bugs fixed (e.g. the top issue `ifs=\\`) and failing baseline packages removed, we're currently at only **62 relevant packages** as you can see in the current [Dasboard](https://op.oils.pub/aports-build/2025-09-06-edit.wwz/_tmp/aports-report/2025-09-06-edit/diff_merged.html) (as of writing). We might do an extension to Bash and/or the community packages sooner than I thought. ðŸ¤©

You might notice that (at the time of writing...) the dashboard doesn't contain my categorizations... Putting these into the repository will be my next task after publishing this article. So you might already see them - or not anymore, because we fixed them all! ðŸ˜›

| Thanks a lot for your interest! And once again, if you got interested in the project, we're very glad for *any* feedback. Be it a [pull request](https://github.com/oils-for-unix/oils/pulls), a [bug report](https://github.com/oils-for-unix/oils/issues] or just an introduction on [Zulipchat](https://oilshell.zulipchat.com/#narrow/channel/119655-new-members) to get to know us and the project :) |
